<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Calibrate (Sliders bottom + Vertical buttons)</title>
  <meta name="theme-color" content="#ffffff" />
  <style>
    body {
      font-family: "Helvetica Neue", "Hiragino Kaku Gothic ProN", "Meiryo", sans-serif;
      font-weight: bold;
      margin: 0;
      height: 100%;
      background: #fff;
      overflow: hidden;
      color: #000;
      -webkit-user-select: none;
      user-select: none;
    }

    #img {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      object-fit: cover;
      z-index: 0;
    }

    .box {
      position: fixed;
      border: 3px solid #0b5fff;
      background: rgba(11,95,255,0.25);
      box-shadow: 0 0 0 1px rgba(0,0,0,.2) inset;
      z-index: 1;
    }

    .pill {
      position: fixed;
      left: 8px;
      top: 8px;
      background: #fff;
      border: 1px solid #00000040;
      border-radius: 12px;
      padding: 6px 10px;
      font-size: 14px;
      white-space: nowrap;
      z-index: 10;
    }

    .code {
      position: fixed;
      right: 8px;
      top: 8px;
      max-width: 60vw;
      max-height: 40vh;
      overflow: auto;
      background: #fff;
      border: 1px solid #00000033;
      border-radius: 10px;
      padding: 8px;
      font-size: 12px;
      white-space: pre;
      z-index: 10;
    }

    /* 画像切り替え：縦配置（上半分の左側） */
    .img-controls {
      position: fixed;
      top: 15%;
      left: 8px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      background: rgba(255,255,255,0.85);
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid #0003;
      z-index: 10;
    }

    /* 下半分のスライダーUI */
    .ui {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      height: 50%;
      background: rgba(255,255,255,0.9);
      border-top: 2px solid #0003;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: center;
      gap: 10px;
      padding: 10px;
      z-index: 20;
    }

    .btn {
      background: #fff;
      color: #000;
      border: 2px solid #000;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: bold;
      white-space: nowrap;
      flex-shrink: 0;
    }

    .btn:active {
      background: #eee;
      transform: scale(.96);
    }

    .slider {
      display: flex;
      align-items: center;
      gap: 10px;
      width: 90%;
    }

    .slider label {
      min-width: 2em;
      text-align: right;
    }

    .slider input[type="range"] { flex: 1 }

    .slider output {
      min-width: 4em;
      text-align: left;
    }
  </style>
</head>
<body>
  <img id="img" src="./images/1.jpg" alt="">
  <div class="pill" id="info"></div>
  <pre class="code" id="code"></pre>

  <!-- 上半分左側の画像切り替えボタン（縦配置） -->
  <div class="img-controls">
    <button class="btn" id="imgPrev">↑ 前へ</button>
    <div>画像 <span id="imgIndexLabel">1</span> / <span id="imgCountLabel">4</span></div>
    <button class="btn" id="imgNext">↓ 次へ</button>
  </div>

  <!-- 下半分にスライダーUI -->
  <div class="ui">
    <div class="slider">
      <label for="xRange">X</label>
      <input id="xRange" type="range" min="0" max="100" step="0.1">
      <output id="xOut">—</output>
    </div>
    <div class="slider">
      <label for="yRange">Y</label>
      <input id="yRange" type="range" min="0" max="100" step="0.1">
      <output id="yOut">—</output>
    </div>
    <div class="slider">
      <label for="wRange">W</label>
      <input id="wRange" type="range" min="1" max="100" step="0.1">
      <output id="wOut">—</output>
    </div>
    <div class="slider">
      <label for="hRange">H</label>
      <input id="hRange" type="range" min="1" max="100" step="0.1">
      <output id="hOut">—</output>
    </div>

    <div style="display:flex; gap:10px; margin-top:8px;">
      <button class="btn" id="save">保存</button>
      <button class="btn" id="back">戻る</button>
    </div>
  </div>

  <script>
    const IMAGE_COUNT = 4;
    const IMAGES = Array.from({length: IMAGE_COUNT}, (_,i)=>`./images/${i+1}.jpg`);
    const KEY = 'tapnext.hotspots';

    const store = JSON.parse(localStorage.getItem(KEY) || '{}');
    let imgIndex = 0;

    const imgEl = document.getElementById('img');
    const info  = document.getElementById('info');
    const code  = document.getElementById('code');

    const imgPrev = document.getElementById('imgPrev');
    const imgNext = document.getElementById('imgNext');
    const saveBtn = document.getElementById('save');
    const backBtn = document.getElementById('back');

    const imgIndexLabel = document.getElementById('imgIndexLabel');
    const imgCountLabel = document.getElementById('imgCountLabel');

    const xRange = document.getElementById('xRange');
    const yRange = document.getElementById('yRange');
    const wRange = document.getElementById('wRange');
    const hRange = document.getElementById('hRange');
    const xOut = document.getElementById('xOut');
    const yOut = document.getElementById('yOut');
    const wOut = document.getElementById('wOut');
    const hOut = document.getElementById('hOut');

    const clamp01 = v => Math.max(0, Math.min(100, v));
    const list = () => store[imgIndex] || (store[imgIndex] = []);
    function cur(){
      const L = list();
      if (L.length === 0) L.push({x:10, y:20, w:80, h:12});
      return L[0];
    }

    function getDispRect(){
      const vw=innerWidth, vh=innerHeight;
      const iw=imgEl.naturalWidth||1, ih=imgEl.naturalHeight||1;
      const s=Math.max(vw/iw, vh/ih);
      const dw=iw*s, dh=ih*s, dx=(vw-dw)/2, dy=(vh-dh)/2;
      return {x:dx,y:dy,w:dw,h:dh};
    }
    function imgToScreen(r){
      const R=getDispRect();
      const L=R.x+(r.x/100)*R.w, T=R.y+(r.y/100)*R.h;
      const W=(r.w/100)*R.w, H=(r.h/100)*R.h;
      return {L,T,W,H};
    }

    function showImage(){
      imgEl.src = IMAGES[imgIndex];
      imgIndexLabel.textContent = (imgIndex+1);
      imgCountLabel.textContent = IMAGE_COUNT;
    }

    function render(){
      document.querySelectorAll('.box').forEach(n=>n.remove());
      const r = cur();

      xRange.max = (100 - r.w).toFixed(1);
      yRange.max = (100 - r.h).toFixed(1);

      xRange.value = r.x.toFixed(2); xOut.textContent = r.x.toFixed(1)+'%';
      yRange.value = r.y.toFixed(2); yOut.textContent = r.y.toFixed(1)+'%';
      wRange.value = r.w.toFixed(2); wOut.textContent = r.w.toFixed(1)+'%';
      hRange.value = r.h.toFixed(2); hOut.textContent = r.h.toFixed(1)+'%';

      const s = imgToScreen(r);
      const el = document.createElement('div');
      el.className = 'box';
      el.style.left = s.L+'px';
      el.style.top  = s.T+'px';
      el.style.width  = s.W+'px';
      el.style.height = s.H+'px';
      document.body.appendChild(el);

      info.textContent = `${imgIndex+1}/${IMAGE_COUNT}  矩形:1`;
      code.textContent = JSON.stringify(store, null, 2);
    }

    imgPrev.onclick = ()=>{ imgIndex = (imgIndex-1+IMAGE_COUNT)%IMAGE_COUNT; showImage(); };
    imgNext.onclick = ()=>{ imgIndex = (imgIndex+1)%IMAGE_COUNT; showImage(); };
    saveBtn.onclick = ()=>{
      localStorage.setItem(KEY, JSON.stringify(store));
      navigator.clipboard?.writeText(JSON.stringify(store));
      render();
    };
    backBtn.onclick = ()=>{ location.href = './index.html'; };

    xRange.oninput = ()=>{ const r=cur(); r.x = clamp01(parseFloat(xRange.value)); render(); };
    yRange.oninput = ()=>{ const r=cur(); r.y = clamp01(parseFloat(yRange.value)); render(); };
    wRange.oninput = ()=>{
      const r=cur(); r.w = clamp01(parseFloat(wRange.value));
      if (r.x > 100 - r.w) r.x = 100 - r.w;
      render();
    };
    hRange.oninput = ()=>{
      const r=cur(); r.h = clamp01(parseFloat(hRange.value));
      if (r.y > 100 - r.h) r.y = 100 - r.h;
      render();
    };

    imgEl.addEventListener('load', render);
    showImage();
  </script>
</body>
</html>
