<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Swipe Viewer</title>
  <link rel="manifest" href="manifest.webmanifest" />
  <meta name="theme-color" content="#000000">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <style>
    html, body {
      margin: 0;
      height: 100%;
      background: #000;
      overflow: hidden;
      -webkit-user-select: none;
      user-select: none;
    }
    #img {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      object-fit: cover; /* 全画面、多少切れてもOK */
    }
  </style>
</head>
<body>
  <img id="img" src="./images/1.jpg" />
  <script>
    const IMAGE_COUNT = 4; // 枚数
    const IMAGES = Array.from({length: IMAGE_COUNT}, (_, i) => `./images/${i+1}.jpg`);
    const HOTSPOTS_IMG = JSON.parse(localStorage.getItem('tapnext.hotspots') || '{}');

    let index = 0;
    const imgEl = document.getElementById('img');

    function clamp(i){ return (i+IMAGES.length)%IMAGES.length; }
    function show(){ imgEl.src = IMAGES[index]; }
    function next(){ index = clamp(index+1); show(); }
    function prev(){ index = clamp(index-1); show(); }

    function getDispRect(){
      const vw=innerWidth, vh=innerHeight;
      const iw=imgEl.naturalWidth||1, ih=imgEl.naturalHeight||1;
      const s=Math.max(vw/iw, vh/ih);
      const dw=iw*s, dh=ih*s, dx=(vw-dw)/2, dy=(vh-dh)/2;
      return {x:dx,y:dy,w:dw,h:dh};
    }
    function imgPercentToScreen(r){
      const R=getDispRect();
      return {
        L: R.x+(r.x/100)*R.w,
        T: R.y+(r.y/100)*R.h,
        W: (r.w/100)*R.w,
        H: (r.h/100)*R.h
      };
    }
    function hit(x,y){
      const list=HOTSPOTS_IMG[index]||[];
      return list.some(r=>{
        const R=imgPercentToScreen(r);
        return (x>=R.L && x<=R.L+R.W && y>=R.T && y<=R.T+R.H);
      });
    }

    document.addEventListener('click', e=>{ if(hit(e.clientX,e.clientY)) next(); });
    let sx=0;
    document.addEventListener('touchstart', e=>{ sx=e.changedTouches[0].clientX; }, {passive:true});
    document.addEventListener('touchend', e=>{
      const t=e.changedTouches[0], dx=t.clientX-sx;
      if(Math.abs(dx)>50){ dx<0?next():prev(); return; }
      if(hit(t.clientX,t.clientY)) next();
    }, {passive:true});

    // 裏モード: 最初の画像を10回タップすると calibrate.html へ
    let secret=0;
    function secretTap(){ if(index===0){ secret++; if(secret>=10) location.href='./calibrate.html'; } }
    document.addEventListener('click', secretTap);
    document.addEventListener('touchend', secretTap, {passive:true});

    show();
    if("serviceWorker" in navigator){
      addEventListener("load", ()=>navigator.serviceWorker.register("./sw.js").catch(console.error));
    }
  </script>
</body>
</html>
