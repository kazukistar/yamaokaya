<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>偽岡屋</title>

  <!-- iOS / PWA 設定 -->
  <link rel="apple-touch-icon" href="./icons/icon-180.png">
  <link rel="manifest" href="./manifest2.webmanifest">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="偽岡屋">
  <meta name="theme-color" content="#ffffff">

  <!-- キャッシュ完全無視 -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <style>
    :root { --mask-extra: 20px; }

    body {
      margin: 0;
      height: 100%;
      background: #fff;
      overflow: hidden;
      -webkit-user-select: none;
      user-select: none;
    }
    #img {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      object-fit: cover;
      z-index: 0;
    }
    .top-mask {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: calc(env(safe-area-inset-top, 44px) + var(--mask-extra));
      background: #fff;
      z-index: 10;
      pointer-events: none;
    }
  </style>
</head>
<body>
  <img id="img" src="./images/1.jpg" alt="">
  <div class="top-mask"></div>

  <script>
    const IMAGE_COUNT = 4;
    const IMAGES = Array.from({length: IMAGE_COUNT}, (_,i)=>`./images/${i+1}.jpg`);
    const KEY = 'tapnext.hotspots';
    let imgIndex = 0;
    const imgEl = document.getElementById('img');
    const store = JSON.parse(localStorage.getItem(KEY) || '{}');

    function showImage(){ imgEl.src = IMAGES[imgIndex]; }

    function hit(x,y){
      const rect = imgEl.getBoundingClientRect();
      const nx = ((x-rect.left)/rect.width)*100;
      const ny = ((y-rect.top)/rect.height)*100;
      const list = store[imgIndex] || [];
      return list.find(r => nx>=r.x && nx<=r.x+r.w && ny>=r.y && ny<=r.y+r.h);
    }

    function handleTap(x,y){
      if (imgIndex === 0) {
        secretCount++;
        if (secretCount >= 10) { location.href = './calibrate.html'; return; }
        clearTimeout(secretTimer);
        secretTimer = setTimeout(()=>secretCount=0, 1200);
      }
      if (hit(x,y)) {
        imgIndex = (imgIndex+1) % IMAGE_COUNT;
        showImage();
      }
    }

    let startX = null;
    document.addEventListener('touchstart', e=>{ startX=e.touches[0].clientX; }, {passive:true});
    document.addEventListener('touchend', e=>{
      const t=e.changedTouches[0];
      const dx=t.clientX-(startX??t.clientX);
      if (Math.abs(dx)>50) {
        imgIndex = (dx<0)?(imgIndex+1)%IMAGE_COUNT:(imgIndex-1+IMAGE_COUNT)%IMAGE_COUNT;
        showImage();
      } else handleTap(t.clientX, t.clientY);
    }, {passive:true});
    document.addEventListener('click', e=>{ handleTap(e.clientX, e.clientY); });

    let secretCount=0, secretTimer=null;
    showImage();
  </script>
</body>
</html>